var crossPlatformText={getInstance:function(args){var format,targetImage,targetSelector=args.targetSelector,target=document.querySelector(targetSelector),targetTagName=target.tagName,htmlContainerElements=["div","section","p"];targetTagName&&htmlContainerElements.indexOf(targetTagName.toLowerCase())>-1?(format=args.format,targetImage=this[format].createTargetImage(crossPlatformTextInstance,target)):(format=targetTagName,targetImage=target);var crossPlatformTextInstance=(this[format].getOrCreateViewport(this,targetImage),Object.create(this));return crossPlatformTextInstance.targetImage=targetImage,Object.keys(this[format]).forEach(function(key){crossPlatformTextInstance[key]||(crossPlatformTextInstance[key]="object"==typeof crossPlatformTextInstance[key]?Object.create(crossPlatformTextInstance[format][key]):crossPlatformTextInstance[format][key])}),crossPlatformTextInstance},isNumber:function(n){return!isNaN(parseFloat(n))&&isFinite(n)},convertToPx:function(inputString,fontSize){var inputStringLowerCased,px;return this.isNumber(inputString)?px=inputString:(inputStringLowerCased=inputString.toLowerCase(),px=inputStringLowerCased.indexOf("em")>-1?inputStringLowerCased.slice(0,inputStringLowerCased.length-2)*fontSize:inputStringLowerCased.indexOf("px")>-1?inputStringLowerCased.slice(0,inputStringLowerCased.length-2):inputStringLowerCased.indexOf("pt")>-1?inputStringLowerCased.slice(0,inputStringLowerCased.length-2)*(4/3):inputStringLowerCased.indexOf("%")>-1?inputStringLowerCased.slice(0,inputStringLowerCased.length-1)/100*fontSize:inputString),px}};crossPlatformText.svg={xmlNS:"http://www.w3.org/XML/1998/namespace",svgNS:"http://www.w3.org/2000/svg",xmlnsNS:"http://www.w3.org/2000/xmlns/",xlinkNS:"http://www.w3.org/1999/xlink",evNS:"http://www.w3.org/2001/xml-events",createTargetImage:function(crossPlatformTextInstance,targetElement){var svgId="svg-"+(new Date).toISOString().replace(/\D/g,""),targetSvg=document.createElementNS(this.svgNS,"svg");return targetSvg.setAttribute("xmlns",this.svgNS),targetSvg.setAttributeNS(this.xmlnsNS,"xmlns:xlink",this.xlinkNS),targetSvg.setAttributeNS(this.xmlnsNS,"xmlns:ev",this.evNS),targetSvg.setAttribute("id",svgId),targetSvg.setAttribute("version","1.1"),targetSvg.setAttribute("baseProfile","full"),targetSvg.setAttribute("preserveAspectRatio","xMidYMid"),targetSvg.setAttribute("width","100%"),targetSvg.setAttribute("height","100%"),targetElement.appendChild(targetSvg),this.targetImage=targetSvg,targetSvg},getOrCreateViewport:function(crossPlatformTextInstance,targetSvg){var viewport=targetSvg.querySelector("g.viewport");if(!viewport){var viewportId="viewport-"+(new Date).toISOString().replace(/\D/g,"");viewport=document.createElementNS(this.svgNS,"g"),viewport.setAttribute("id",viewportId),viewport.setAttribute("class","viewport");var targetSvgChildren=targetSvg.childNodes||targetSvg.children;if(targetSvgChildren&&targetSvgChildren.length>0)do viewport.appendChild(targetSvgChildren[0]);while(targetSvgChildren.length>0);targetSvg.appendChild(viewport)}return viewport},render:function(data,callback){data.color=data.color||"black",data.fontSize=data.fontSize||12,data.padding=data.padding||0;var attributeDependencyOrder=(this.crossPlatformTextInstance,["fontSize"]),textContentSplitIntoLines=data.textContent.split(/\r\n|\r|\n|&#xA;/g),textLineCount=textContentSplitIntoLines.length,padding=data.padding,width=data.width,height=data.height,fontSize=data.fontSize,paddingInPx=crossPlatformText.convertToPx(padding,fontSize);fontSize=crossPlatformText.convertToPx(fontSize,fontSize);var textAnchor;"left"===data.textAlign?(textAnchor="start",textAlignXTranslation=paddingInPx):"right"===data.textAlign?(textAnchor="end",textAlignXTranslation=width-paddingInPx):(textAnchor="middle",textAlignXTranslation=width/2);var verticalAlignYTranslation,xTranslation=data.x+textAlignXTranslation,textAreaHeight=1.1*(textLineCount-1)*fontSize;verticalAlignYTranslation="top"===data.verticalAlign?paddingInPx+textAreaHeight/2+fontSize*(2/3):"bottom"===data.verticalAlign?height-paddingInPx-textAreaHeight/2-fontSize*(2/3):height/2;var yTranslation=data.y+verticalAlignYTranslation,transform="translate("+xTranslation+" "+yTranslation+")",textArea=document.createElementNS(this.svgNS,"g");textArea.setAttribute("transform",transform),data.containerSelector?this.targetImage.querySelector(data.containerSelector).appendChild(textArea):this.targetImage.appendChild(textArea);var textAreaSelection=d3.select(textArea),attributes=(textAreaSelection.selectAll("text").data(textContentSplitIntoLines).enter().append("text").attr("id",function(d,i){return"text-line"+i}).attr("x",0).attr("y",function(d,i){return 1.1*(i-(textLineCount-1)/2)+"em"}).attr("dominant-baseline","central").attr("text-anchor",textAnchor).text(function(d){return d}),[]),backgroundColor=data.backgroundColor||"transparent";attributes.push({name:"fill",value:backgroundColor});var attributeListItemName,attributeListItemValue,svgTextAttributeGenerator={color:function(colorValue){textAreaSelection.attr("fill",colorValue)},id:function(idValue){textAreaSelection.attr("id","text-for-"+idValue)},fill:function(fillValue){textAreaSelection.attr("fill",fillValue)},fillOpacity:function(fillOpacityValue){textAreaSelection.attr("fill-opacity",fillOpacityValue)},fontFamily:function(fontFamilyValue){textAreaSelection.attr("font-family",fontFamilyValue)},fontSize:function(fontSizeValue){textAreaSelection.attr("font-size",fontSizeValue)},fontStyle:function(fontStyleValue){textAreaSelection.attr("font-style",fontStyleValue)},fontWeight:function(fontWeightValue){textAreaSelection.attr("font-weight",fontWeightValue)},rotation:function(rotationValue){transform+=" rotate("+rotationValue+","+(width/2-textAlignXTranslation)+","+(height/2-verticalAlignYTranslation)+")",textAreaSelection.attr("transform",transform)}},attributeList=d3.map(data).entries().sort(function(a,b){return attributeDependencyOrder.indexOf(a.key)-attributeDependencyOrder.indexOf(b.key)});return attributeList.forEach(function(attributeListItem){attributeListItemName=attributeListItem.key,attributeListItemValue=attributeListItem.value,svgTextAttributeGenerator.hasOwnProperty(attributeListItemName)&&svgTextAttributeGenerator[attributeListItemName](attributeListItemValue)}),callback?callback(textAreaSelection[0][0]):textAreaSelection[0][0]}},crossPlatformText.canvas={};